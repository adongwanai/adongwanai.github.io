---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const notes = await getCollection('vibecoding');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

const { note } = Astro.props;
const { Content, headings } = await note.render();

const allNotes = (await getCollection('vibecoding')).sort(
  (a, b) => a.data.order - b.data.order
);

const currentIndex = allNotes.findIndex(n => n.slug === note.slug);
const prevNote = currentIndex > 0 ? allNotes[currentIndex - 1] : null;
const nextNote = currentIndex < allNotes.length - 1 ? allNotes[currentIndex + 1] : null;

// Group notes by directory for the sidebar
const groupedNotes = allNotes.reduce((acc, currentNote) => {
  const parts = currentNote.slug.split('/');
  const folder = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Overview';
  
  if (!acc[folder]) acc[folder] = [];
  acc[folder].push(currentNote);
  return acc;
}, {} as Record<string, typeof allNotes>);

const currentFolder = note.slug.split('/').length > 1 ? note.slug.split('/').slice(0, -1).join('/') : 'Overview';
---

<Layout title={`${note.data.title} - 阿东的 VibeCoding 赚钱笔记`}>
  <div class="pt-[90px] pb-24 px-4 sm:px-6 lg:px-8 max-w-[1440px] mx-auto flex flex-col md:flex-row gap-8">
    
    <!-- Left Sidebar (Menu) -->
    <aside class="hidden md:block w-64 lg:w-72 shrink-0">
      <div class="sticky top-[90px] h-[calc(100vh-[90px])] overflow-y-auto pr-4 pb-12 custom-scrollbar border-r border-gray-200 dark:border-white/10">
        <div class="mb-6">
           <a href="/vibecoding" class="text-sm font-semibold text-gray-500 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 transition-colors">
             ← 赚钱笔记首页
           </a>
        </div>
        
        <div class="flex flex-col gap-6">
          {Object.entries(groupedNotes).map(([folder, folderNotes]) => (
            <div class="flex flex-col gap-2">
               {folder !== 'Overview' && (
                 <h3 class="font-bold text-gray-900 dark:text-gray-100 text-sm mb-1">{folder}</h3>
               )}
               <nav class="flex flex-col gap-[2px] border-l border-gray-200 dark:border-white/10 ml-2 pl-3">
                {folderNotes.map((item) => (
                  <a 
                    href={`/vibecoding/${item.slug}`} 
                    class={`block py-1.5 px-3 rounded-md text-sm transition-all duration-200 ${
                      item.slug === note.slug 
                        ? 'bg-blue-50 text-blue-600 font-medium dark:bg-blue-500/10 dark:text-blue-400' 
                        : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white'
                    }`}
                  >
                    {item.data.title}
                  </a>
                ))}
               </nav>
            </div>
          ))}
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 min-w-0 max-w-3xl lg:px-8 mt-4 md:mt-0">
      <!-- Breadcrumbs -->
      <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-8 font-medium space-x-2">
        <a href="/vibecoding" class="hover:text-gray-900 dark:hover:text-white transition-colors">赚钱笔记</a>
        <span>/</span>
        {currentFolder !== 'Overview' && (
          <>
            <span class="text-gray-600 dark:text-gray-300">{currentFolder}</span>
            <span>/</span>
          </>
        )}
        <span class="text-gray-900 dark:text-white truncate">{note.data.title}</span>
      </nav>

      <article class="prose prose-gray dark:prose-invert prose-lg max-w-none 
        prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-white
        prose-h2:text-2xl prose-h3:text-xl
        prose-a:text-accent prose-a:no-underline hover:prose-a:underline 
        prose-img:rounded-xl prose-img:border prose-img:border-gray-200 dark:prose-img:border-white/10 
        prose-hr:border-gray-200 dark:prose-hr:border-white/10
        prose-code:text-accent prose-code:bg-blue-50 dark:prose-code:bg-blue-900/20 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
        prose-pre:border prose-pre:border-gray-200 dark:prose-pre:border-white/10 prose-pre:bg-[#1e1e1e]">
        
        <header class="mb-10 not-prose">
          <h1 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight text-gray-900 dark:text-white tracking-tight">{note.data.title}</h1>
          <p class="text-gray-500 dark:text-gray-400 text-lg">{note.data.description}</p>
        </header>

        <Content />
      </article>
      
      <!-- Prev/Next Navigation -->
      <div class="mt-16 pt-8 border-t border-gray-200 dark:border-white/10 grid grid-cols-1 sm:grid-cols-2 gap-4 not-prose">
        {prevNote ? (
          <a href={`/vibecoding/${prevNote.slug}`} class="flex flex-col gap-1 p-4 rounded-xl border border-gray-200 dark:border-white/10 hover:border-accent dark:hover:border-accent hover:shadow-md transition-all group">
            <span class="text-xs text-gray-500 dark:text-gray-400 font-medium tracking-wider uppercase">上一页</span>
            <span class="text-accent font-medium group-hover:underline line-clamp-2">{prevNote.data.title}</span>
          </a>
        ) : <div></div>}
        
        {nextNote ? (
          <a href={`/vibecoding/${nextNote.slug}`} class="flex flex-col items-end text-right gap-1 p-4 rounded-xl border border-gray-200 dark:border-white/10 hover:border-accent dark:hover:border-accent hover:shadow-md transition-all group">
            <span class="text-xs text-gray-500 dark:text-gray-400 font-medium tracking-wider uppercase">下一页</span>
            <span class="text-accent font-medium group-hover:underline line-clamp-2">{nextNote.data.title}</span>
          </a>
        ) : <div></div>}
      </div>
    </main>

    <!-- Right Sidebar (Table of Contents) -->
    {headings && headings.length > 0 && (
      <aside class="hidden xl:block w-64 shrink-0 relative">
        <div class="sticky top-[90px] h-[calc(100vh-[90px])] overflow-y-auto pl-4 pb-12 custom-scrollbar">
          <h4 class="font-semibold text-gray-900 dark:text-white tracking-wider text-sm mb-4">本页内容</h4>
          <nav class="flex flex-col gap-1.5 relative border-l border-gray-200 dark:border-white/10" id="toc-nav">
            {headings.map((heading) => (
              heading.depth > 1 && heading.depth < 4 && (
                <a 
                  href={`#${heading.slug}`} 
                  class={`block text-sm py-1 transition-colors hover:text-accent toc-link
                    ${heading.depth === 2 ? 'pl-4 text-gray-700 dark:text-gray-300 font-medium' : 'pl-8 text-gray-500 dark:text-gray-400'}
                  `}
                  data-slug={heading.slug}
                >
                  {heading.text}
                </a>
              )
            ))}
          </nav>
        </div>
      </aside>
    )}

  </div>
</Layout>

<style>
  html {
    scroll-padding-top: 100px; /* Offset for sticky header when jumping to anchors */
  }
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.3);
    border-radius: 20px;
  }
  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .custom-scrollbar:hover::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
  }
</style>

<script>
  // Simple active TOC highlighting based on scroll
  document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver((entries) => {
      // Find the currently intersecting entry
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          const navLinks = document.querySelectorAll('.toc-link');
          
          navLinks.forEach(link => {
            link.classList.remove('text-accent', 'font-bold');
            if (link.getAttribute('href') === `#${id}`) {
              link.classList.add('text-accent', 'font-bold');
            }
          });
        }
      });
    }, { rootMargin: '-100px 0px -60% 0px' }); // Top margin counters sticky header

    // Observe all headings
    document.querySelectorAll('h2, h3').forEach(heading => {
      observer.observe(heading);
    });
  });
</script>
