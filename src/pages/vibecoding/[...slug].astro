---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const notes = await getCollection('vibecoding');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

const { note } = Astro.props;
const { Content, headings } = await note.render();

const allNotes = (await getCollection('vibecoding')).sort(
  (a, b) => a.data.order - b.data.order
);

const currentIndex = allNotes.findIndex(n => n.slug === note.slug);
const prevNote = currentIndex > 0 ? allNotes[currentIndex - 1] : null;
const nextNote = currentIndex < allNotes.length - 1 ? allNotes[currentIndex + 1] : null;

// Group notes by directory for the sidebar
const groupedNotes = allNotes.reduce((acc, currentNote) => {
  const parts = currentNote.slug.split('/');
  const folder = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Overview';
  
  if (!acc[folder]) acc[folder] = [];
  acc[folder].push(currentNote);
  return acc;
}, {} as Record<string, typeof allNotes>);

const currentFolder = note.slug.split('/').length > 1 ? note.slug.split('/').slice(0, -1).join('/') : 'Overview';
---

<Layout title={`${note.data.title} - 阿东的 VibeCoding 赚钱笔记`}>
  <div class="bg-gray-50 dark:bg-[#13151a] min-h-screen pt-[70px]">
    <div class="px-4 sm:px-6 lg:px-8 max-w-[1440px] mx-auto flex flex-col md:flex-row gap-6 lg:gap-8 pt-6 pb-24">
      
      <!-- Left Sidebar (Menu) -->
      <aside class="hidden md:block w-64 lg:w-72 shrink-0">
        <div class="sticky top-[94px] h-[calc(100vh-[94px])] overflow-y-auto pr-2 pb-12 custom-scrollbar border-r border-gray-200 dark:border-white/10">
          
          <div class="flex flex-col gap-4">
            {Object.entries(groupedNotes).map(([folder, folderNotes]) => (
              <details class="group" open>
                 <summary class="flex items-center justify-between cursor-pointer py-2 px-3 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg text-sm font-bold text-gray-900 dark:text-gray-100 select-none transition-colors">
                   <span>{folder === 'Overview' ? '关于本系列' : folder}</span>
                   <svg class="w-4 h-4 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                   </svg>
                 </summary>
                 <nav class="mt-1 flex flex-col gap-1 pl-3 ml-2 border-l border-gray-200 dark:border-white/10">
                  {folderNotes.map((item) => (
                    <a 
                      href={`/vibecoding/${item.slug}`} 
                      class={`block py-1.5 px-3 rounded-lg text-sm transition-all duration-200 ${
                        item.slug === note.slug 
                          ? 'bg-emerald-50 text-emerald-700 font-medium dark:bg-emerald-500/10 dark:text-emerald-400' 
                          : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white'
                      }`}
                    >
                      {item.data.title}
                    </a>
                  ))}
                 </nav>
              </details>
            ))}
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 min-w-0 max-w-4xl lg:px-4">
        
        <!-- Document Title Card -->
        <div class="bg-white dark:bg-[#17181c] rounded-xl border border-gray-200 dark:border-white/5 p-6 md:p-8 shadow-sm mb-6">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white tracking-tight">{note.data.title}</h1>
        </div>

        <!-- Document Content Card -->
        <div class="bg-white dark:bg-[#17181c] rounded-xl border border-gray-200 dark:border-white/5 p-6 md:p-8 shadow-sm">
          <article class="prose prose-gray dark:prose-invert prose-lg max-w-none 
            prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-white
            prose-h2:text-2xl prose-h2:mt-12 prose-h2:border-b prose-h2:border-gray-200 dark:prose-h2:border-white/10 prose-h2:pb-2
            prose-h3:text-xl
            prose-a:text-accent prose-a:no-underline hover:prose-a:underline 
            prose-img:rounded-xl prose-img:border prose-img:border-gray-200 dark:prose-img:border-white/10 prose-img:shadow-sm
            prose-hr:border-gray-200 dark:prose-hr:border-white/10
            prose-code:text-accent prose-code:bg-blue-50 dark:prose-code:bg-blue-900/20 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
            prose-pre:border prose-pre:border-gray-200 dark:prose-pre:border-white/10 prose-pre:bg-[#1e1e1e] prose-pre:shadow-sm">
            <Content />
          </article>
        </div>
        
        <!-- Prev/Next Navigation -->
        <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 not-prose">
          {prevNote ? (
            <a href={`/vibecoding/${prevNote.slug}`} class="flex flex-col gap-1 p-5 rounded-xl bg-white dark:bg-[#17181c] border border-gray-200 dark:border-white/5 shadow-sm hover:border-accent dark:hover:border-accent hover:shadow-md transition-all group">
              <span class="text-xs text-gray-500 dark:text-gray-400 font-medium tracking-wider uppercase">上一页</span>
              <span class="text-accent font-medium group-hover:underline line-clamp-2">{prevNote.data.title}</span>
            </a>
          ) : <div></div>}
          
          {nextNote ? (
            <a href={`/vibecoding/${nextNote.slug}`} class="flex flex-col items-end text-right gap-1 p-5 rounded-xl bg-white dark:bg-[#17181c] border border-gray-200 dark:border-white/5 shadow-sm hover:border-accent dark:hover:border-accent hover:shadow-md transition-all group">
              <span class="text-xs text-gray-500 dark:text-gray-400 font-medium tracking-wider uppercase">下一页</span>
              <span class="text-accent font-medium group-hover:underline line-clamp-2">{nextNote.data.title}</span>
            </a>
          ) : <div></div>}
        </div>
      </main>

      <!-- Right Sidebar (Table of Contents) -->
      {headings && headings.length > 0 && (
        <aside class="hidden xl:block w-64 shrink-0">
          <div class="sticky top-[94px]">
            <div class="bg-white dark:bg-[#17181c] rounded-xl border border-gray-200 dark:border-white/5 p-5 shadow-sm">
              <h4 class="font-bold text-gray-900 dark:text-white text-base mb-4 tracking-wide">On this page</h4>
              <nav class="flex flex-col gap-2 relative" id="toc-nav">
                {headings.map((heading) => (
                  heading.depth > 1 && heading.depth < 4 && (
                    <a 
                      href={`#${heading.slug}`} 
                      class={`block text-sm transition-colors hover:text-accent toc-link
                        ${heading.depth === 2 ? 'text-gray-600 dark:text-gray-300' : 'pl-4 text-gray-500 dark:text-gray-400'}
                      `}
                      data-slug={heading.slug}
                    >
                      {heading.text}
                    </a>
                  )
                ))}
              </nav>
            </div>
          </div>
        </aside>
      )}

    </div>
  </div>
</Layout>

<style>
  html {
    scroll-padding-top: 100px; /* Offset for sticky header when jumping to anchors */
  }
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.3);
    border-radius: 20px;
  }
  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .custom-scrollbar:hover::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
  }
</style>

<script>
  // Simple active TOC highlighting based on scroll
  document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver((entries) => {
      // Find the currently intersecting entry
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          const navLinks = document.querySelectorAll('.toc-link');
          
          navLinks.forEach(link => {
            link.classList.remove('text-accent', 'font-bold');
            if (link.getAttribute('href') === `#${id}`) {
              link.classList.add('text-accent', 'font-bold');
            }
          });
        }
      });
    }, { rootMargin: '-100px 0px -60% 0px' }); // Top margin counters sticky header

    // Observe all headings
    document.querySelectorAll('h2, h3').forEach(heading => {
      observer.observe(heading);
    });
  });
</script>
