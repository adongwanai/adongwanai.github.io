---
import Layout from '../layouts/Layout.astro';
import Terminal from '../components/Terminal.astro';
import VisitorStats from '../components/VisitorStats.astro';
import { getCollection } from 'astro:content';

import Hero from '../components/sections/Hero.astro';
import Workflow from '../components/sections/Workflow.astro';
import OperatingSystem from '../components/sections/OperatingSystem.astro';
import Projects from '../components/sections/Projects.astro';
import LearningPath from '../components/sections/LearningPath.astro';
import LatestArticles from '../components/sections/LatestArticles.astro';
import About from '../components/sections/About.astro';
import Cooperation from '../components/sections/Cooperation.astro';

const projects = await getCollection('projects');
const projectStats = await Promise.all(projects.map(async (p) => {
    let stars = p.data.stars || "0";
    let forks = p.data.forks || "0";
    
    // Extract repo from link if it's a GitHub URL
    const match = p.data.link.match(/github\.com\/([^/]+\/[^/]+)/);
    if (match) {
        try {
           const repo = match[1];
           const res = await fetch(`https://api.github.com/repos/${repo}`);
           if (res.ok) {
               const data = await res.json();
               // Only format if > 1000, otherwise show exact number
               stars = data.stargazers_count >= 1000 
                   ? (data.stargazers_count / 1000).toFixed(1) + 'k' 
                   : data.stargazers_count.toString();
               forks = data.forks_count.toString();
           }
        } catch (e) {
            console.error(`Error fetching stats for ${p.data.title}:`, e);
        }
    }
    return { ...p, dynamicStars: stars, dynamicForks: forks };
}));

const sortedProjects = projectStats.sort((a, b) => a.data.order - b.data.order);
const latestPosts = (await getCollection('posts')).slice(0, 3);

---

<Layout title="大模型算法工程师 & AI Agent 开发者 | 阿东玩AI - Vibe Coding 实战" description="大模型算法工程师 & AI Agent 开发者，专注 Vibe Coding、Claude Skills、MCP 服务器开发。分享 AI 工作流与实战经验，帮助开发者提升 10x 编程效率。1.5k+ GitHub Stars，20k+ 粉丝。">
  <Hero />
  <Workflow />
  <OperatingSystem />
  <Projects projects={sortedProjects} />
  <LearningPath />
  <LatestArticles posts={latestPosts} />
  <About />
  <Cooperation />
  
  <!-- Terminal Section -->
  <section class="py-12">
    <Terminal />
  </section>

  <!-- Visitor Stats Section -->
  <section class="py-8 bg-gray-50 dark:bg-white/5">
    <VisitorStats />
  </section>
</Layout>

<script>
  // Spotlight Effect
  const cards = document.querySelectorAll('.spotlight-card');
  
  cards.forEach(card => {
    card.addEventListener('mousemove', (e) => {
      // Cast the event target to HTMLElement to access bounding rect and style
      const rect = (card as HTMLElement).getBoundingClientRect();
      const x = (e as MouseEvent).clientX - rect.left;
      const y = (e as MouseEvent).clientY - rect.top;
      
      (card as HTMLElement).style.setProperty('--x', `${x}px`);
      (card as HTMLElement).style.setProperty('--y', `${y}px`);
    });
  });
</script>